<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiblioTech - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/dashboards/dash_estudiante.css">
    <link rel="stylesheet" href="/css/home.css">
</head>

<body>
    <!-- <div th:replace="fragments/navbar :: navbar"></div> -->

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="sidebar-menu">
                    <a href="/estudiante/dashboard/inicio" class="menu-item"
                        th:classappend="${seccion == 'inicio'} ? 'active' : ''">
                        <i class="fas fa-home"></i>
                        <span>Inicio</span>
                    </a>
                    <a href="/estudiante/dashboard/prestamos-activos" class="menu-item"
                        th:classappend="${seccion == 'prestamos-activos'} ? 'active' : ''">
                        <i class="fas fa-book"></i>
                        <span>Préstamos activos</span>
                    </a>
                    <a href="/estudiante/dashboard/solicitud-prestamo" class="menu-item"
                        th:classappend="${seccion == 'solicitud-prestamo'} ? 'active' : ''">
                        <i class="far fa-file-alt"></i>
                        <span>Solicitud de préstamos</span>
                    </a>
                    <a href="/estudiante/dashboard/confirmacion-prestamo" class="menu-item"
                        th:classappend="${seccion == 'confirmacion-prestamo'} ? 'active' : ''">
                        <i class="far fa-envelope"></i>
                        <span>Confirmación de préstamos</span>
                    </a>
                    <a href="/estudiante/dashboard/historial-prestamo" class="menu-item"
                        th:classappend="${seccion == 'historial-prestamo'} ? 'active' : ''">
                        <i class="fas fa-history"></i>
                        <span>Historial de préstamos</span>
                    </a>
                    <a th:href="@{/}" class="menu-item">
                        <i class="fas fa-home"></i>
                        <span>Volver al inicio</span>
                    </a>
                </div>
            </div>

            <div class="col-md-9 col-lg-10 main-content">
                <div th:if="${seccion == 'inicio'}">
                    <div class="content-header">
                        <h2>Hola, <strong th:text="${session.usuarioNombre}"></strong></h2>
                        <p class="text-muted">Bienvenido a tu biblioteca digital</p>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-md-6 col-lg-3">
                            <div class="stats-card">
                                <i class="fas fa-book-open stats-icon"></i>
                                <div class="stats-info">
                                    <h3 th:text="${cantidadPrestamosActivos ?: 0}">0</h3>
                                    <p>Préstamos Activos</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <div class="stats-card">
                                <i class="fas fa-file-alt stats-icon"></i>
                                <div class="stats-info">
                                    <h3 th:text="${cantidadSolicitudesPendientes ?: 0}">0</h3>
                                    <p>Solicitudes Pendientes</p>
                                </div>
                            </div>
                        </div>

                        <!-- <div class="col-md-6 col-lg-3">
                            <div class="stats-card">
                                <i class="fas fa-history stats-icon"></i>
                                <div class="stats-info">
                                    <h3>15</h3>
                                    <p>Libros Leídos</p>
                                </div>
                            </div>
                        </div> -->

                        <div class="col-md-6 col-lg-3">
                            <div class="stats-card">
                                <i class="fas fa-calendar-alt stats-icon"></i>
                                <div class="stats-info">
                                    <h3 th:text="${cantidadProximosAVencer ?: 0}">0</h3>
                                    <p>Próximo a Vencer</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="quick-actions-section">
                        <h4 class="mb-3">Acciones Rápidas</h4>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <a href="/estudiante/dashboard/prestamos-activos" class="quick-action-card">
                                    <i class="fas fa-book"></i>
                                    <span>Ver Préstamos Activos</span>
                                </a>
                            </div>
                            <div class="col-md-4">
                                <a href="/estudiante/dashboard/solicitud-prestamo" class="quick-action-card">
                                    <i class="fas fa-file-alt"></i>
                                    <span>Ver Solicitudes</span>
                                </a>
                            </div>
                            <div class="col-md-4">
                                <a href="/estudiante/dashboard/historial-prestamo" class="quick-action-card">
                                    <i class="fas fa-chart-line"></i>
                                    <span>Ver Historial</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="notifications-section mt-4">
                        <h4 class="mb-3">Notificaciones Recientes</h4>

                        <div th:if="${(notificacionesProximoVencer == null or notificacionesProximoVencer.isEmpty()) 
                  and (notificacionesAprobadas == null or notificacionesAprobadas.isEmpty())}"
                            class="alert alert-info">
                            No tienes notificaciones recientes.
                        </div>

                        <div th:each="prestamo : ${notificacionesProximoVencer}" class="notification-item">
                            <div class="notification-icon-wrapper warning">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="notification-content">
                                <p class="notification-title">Devolución Próxima</p>
                                <p class="notification-text">
                                    El libro "<span th:text="${prestamo.libro.titulo}"></span>" debe devolverse en
                                    <span
                                        th:with="diasRestantes=${T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), prestamo.fechaDevolucion)}"
                                        th:text="${diasRestantes == 0 ? 'hoy' : (diasRestantes == 1 ? '1 día' : diasRestantes + ' días')}">
                                    </span>
                                </p>
                                <span class="notification-time"
                                    th:text="'Vence el ' + ${#temporals.format(prestamo.fechaDevolucion, 'dd/MM/yyyy')}">
                                </span>
                            </div>
                        </div>

                        <div th:each="prestamo : ${notificacionesAprobadas}" class="notification-item">
                            <div class="notification-icon-wrapper success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="notification-content">
                                <p class="notification-title">Solicitud Aprobada</p>
                                <p class="notification-text">
                                    Tu solicitud para "<span th:text="${prestamo.libro.titulo}"></span>" ha sido
                                    aprobada, ya puedes recoger el libro en la biblioteca.
                                </p>
                                <span class="notification-time"
                                    th:with="diasPasados=${T(java.time.temporal.ChronoUnit).DAYS.between(prestamo.fechaAprobacion, T(java.time.LocalDate).now())}"
                                    th:text="${diasPasados == 0 ? 'Hoy' : (diasPasados == 1 ? 'Hace 1 día' : 'Hace ' + diasPasados + ' días')}">
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${seccion == 'prestamos-activos'}">
                    <div class="content-header">
                        <h2>Hola, <strong th:text="${session.usuarioNombre}"></strong></h2>
                        <p class="text-muted">Estos son tus prestamos activos:</p>
                    </div>

                    <div class="section-content">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="table-header">
                                    <div class="header-libro">Libro</div>
                                    <div class="header-prestamo">Préstamo</div>
                                    <div class="header-devolucion">Devolución</div>
                                </div>
                            </div>
                        </div>

                        <div th:if="${prestamosActivos == null or prestamosActivos.isEmpty()}" class="alert alert-info">
                            No tienes préstamos activos en este momento.
                        </div>

                        <div th:each="prestamo : ${prestamosActivos}" class="loan-card mb-3">
                            <div class="loan-book-info">
                                <img th:src="@{'/img/libros/' + ${prestamo.libro.imagen}}"
                                    th:alt="${prestamo.libro.titulo}" class="loan-book-cover">
                                <div class="loan-book-details">
                                    <div class="loan-book-title" th:text="${prestamo.libro.titulo}">Título</div>
                                    <div class="loan-book-author" th:text="${prestamo.libro.autor}">Autor</div>
                                    <div class="loan-book-year" th:text="${prestamo.libro.anio}">Año</div>
                                </div>
                            </div>
                            <div class="loan-date"
                                th:text="${#temporals.format(prestamo.fechaAprobacion, 'dd/MM/yyyy')}">
                                Fecha
                            </div>
                            <div class="loan-return-date"
                                th:text="${#temporals.format(prestamo.fechaDevolucion, 'dd/MM/yyyy')}">
                                Devolución
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${seccion == 'solicitud-prestamo'}">
                    <div class="content-header">
                        <h2>Hola, <strong th:text="${session.usuarioNombre}"></strong></h2>
                        <p class="text-muted">Estas son tus solicitudes de préstamo:</p>
                    </div>

                    <div class="section-content">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="table-header-request">
                                    <div class="header-libro-request">Libro</div>
                                    <div class="header-estado">Estado</div>
                                </div>
                            </div>
                        </div>

                        <div th:if="${solicitudes == null or solicitudes.isEmpty()}" class="alert alert-info">
                            No tienes solicitudes pendientes en este momento.
                        </div>

                        <div th:each="prestamo : ${solicitudes}" class="request-card mb-3">
                            <div class="request-book-info">
                                <img th:src="@{'/img/libros/' + ${prestamo.libro.imagen}}"
                                    th:alt="${prestamo.libro.titulo}" class="request-book-cover">
                                <div class="request-book-details">
                                    <div class="request-book-title" th:text="${prestamo.libro.titulo}">Título</div>
                                    <div class="request-book-author" th:text="${prestamo.libro.autor}">Autor</div>
                                    <div class="request-book-year" th:text="${prestamo.libro.anio}">Año</div>
                                </div>
                            </div>
                            <div class="request-actions">
                                <span class="status-badge">Enviado</span>
                                <form th:action="@{/prestamos/cancelar/{id}(id=${prestamo.idPrestamo})}" method="post"
                                    style="display:inline;" th:id="'formCancelar' + ${prestamo.idPrestamo}">
                                    <button type="button" class="btn-cancel"
                                        th:onclick="'mostrarConfirmacionCancelar(' + ${prestamo.idPrestamo} + ')'">
                                        Cancelar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${seccion == 'confirmacion-prestamo'}">
                    <div class="content-header">
                        <h2>Hola, <strong th:text="${session.usuarioNombre}"></strong></h2>
                        <p class="text-muted">Estas son tus confirmaciones de préstamo:</p>
                    </div>

                    <div class="section-content">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="table-header-confirmation">
                                    <div class="header-libro-confirmation">Libro</div>
                                    <div class="header-estado-confirmation">Estado</div>
                                    <div class="header-devolucion-confirmation">Devolución</div>
                                </div>
                            </div>
                        </div>

                        <div th:if="${confirmaciones == null or confirmaciones.isEmpty()}" class="alert alert-info">
                            No tienes confirmaciones en este momento.
                        </div>

                        <div th:each="prestamo : ${confirmaciones}" class="confirmation-card mb-3">
                            <div class="confirmation-book-info">
                                <img th:src="@{'/img/libros/' + ${prestamo.libro.imagen}}"
                                    th:alt="${prestamo.libro.titulo}" class="confirmation-book-cover">
                                <div class="confirmation-book-details">
                                    <div class="confirmation-book-title" th:text="${prestamo.libro.titulo}">Título</div>
                                    <div class="confirmation-book-author" th:text="${prestamo.libro.autor}">Autor</div>
                                    <div class="confirmation-book-year" th:text="${prestamo.libro.anio}">Año</div>
                                </div>
                            </div>
                            <div class="confirmation-status">
                                <i th:if="${prestamo.estado.name() == 'APROBADO'}"
                                    class="fas fa-check-circle status-icon-approved"></i>
                                <i th:if="${prestamo.estado.name() == 'RECHAZADO'}" style="color: #dc3545;"></i>
                                <span th:if="${prestamo.estado.name() == 'RECHAZADO'}"
                                    style="color: #dc3545; font-weight: 600;">Rechazado</span>
                            </div>
                            <div class="confirmation-date"
                                th:text="${#temporals.format(prestamo.fechaDevolucion, 'dd/MM/yyyy')}">
                                Fecha
                            </div>
                            <div class="confirmation-actions" th:if="${prestamo.estado.name() == 'APROBADO'}">
                                <form th:action="@{/prestamos/cancelar-confirmacion/{id}(id=${prestamo.idPrestamo})}"
                                    method="post" style="display:inline;"
                                    th:id="'formCancelarConf' + ${prestamo.idPrestamo}">
                                    <button type="button" class="btn-cancel-confirmation"
                                        th:onclick="'mostrarConfirmacionCancelarConfirmacion(' + ${prestamo.idPrestamo} + ')'">
                                        Cancelar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${seccion == 'historial-prestamo'}">
                    <div class="content-header">
                        <h2>Hola, <strong th:text="${session.usuarioNombre}"></strong></h2>
                        <p class="text-muted">Estos son tus últimos libros prestados:</p>
                    </div>

                    <div class="section-content">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="table-header-history">
                                    <div class="header-libro-history">Libro</div>
                                    <div class="header-estado-history">Estado</div>
                                    <div class="header-devolucion-history">Devolución</div>
                                </div>
                            </div>
                        </div>

                        <div th:if="${historial == null or historial.isEmpty()}" class="alert alert-info">
                            No tienes historial de préstamos.
                        </div>

                        <div th:each="prestamo : ${historial}" class="history-card mb-3">
                            <div class="history-book-info">
                                <img th:src="@{'/img/libros/' + ${prestamo.libro.imagen}}"
                                    th:alt="${prestamo.libro.titulo}" class="history-book-cover">
                                <div class="history-book-details">
                                    <div class="history-book-title" th:text="${prestamo.libro.titulo}">Título</div>
                                    <div class="history-book-author" th:text="${prestamo.libro.autor}">Autor</div>
                                    <div class="history-book-year" th:text="${prestamo.libro.anio}">Año</div>
                                </div>
                            </div>
                            <div class="history-status">

                                <th:block th:if="${prestamo.estado.name() == 'DEVUELTO'}">
                                    <span class="status-text-returned">Devuelto</span>
                                    <i class="fas fa-check-circle status-icon-returned"></i>
                                </th:block>

                                <th:block th:if="${prestamo.estado.name() == 'APROBADO'}">
                                    <span class="status-text-reading">En lectura</span>
                                </th:block>

                                <th:block th:if="${prestamo.estado.name() == 'PENDIENTE'}">
                                    <span class="status-text-pending">Pendiente</span>
                                </th:block>

                                <th:block th:if="${prestamo.estado.name() == 'RECHAZADO'}">
                                    <span class="status-text-rejected" style="color: #dc3545;">Rechazado</span>
                                </th:block>
                            </div>
                            <div class="history-date">
                                <span th:if="${prestamo.fechaDevolucionReal != null}"
                                    th:text="${#temporals.format(prestamo.fechaDevolucionReal, 'dd/MM/yyyy')}">
                                </span>
                                <span th:if="${prestamo.fechaDevolucionReal == null}"
                                    th:text="${#temporals.format(prestamo.fechaDevolucion, 'dd/MM/yyyy')}">
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="modal fade modal-confirm" id="confirmCancelarSolicitud" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="icon-box warning">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h4>¿Cancelar solicitud?</h4>
                        <p>Esta acción no se puede deshacer. La solicitud de préstamo será eliminada.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-cancel-modal" data-bs-dismiss="modal">
                            No, mantener
                        </button>
                        <button type="button" class="btn btn-danger-modal" id="btnConfirmarCancelar">
                            Sí, cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade modal-confirm" id="confirmCancelarConfirmacion" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="icon-box danger">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <h4>¿Cancelar préstamo aprobado?</h4>
                        <p>Este préstamo ya fue aprobado. ¿Estás seguro de cancelarlo?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-cancel-modal" data-bs-dismiss="modal">
                            No, mantener
                        </button>
                        <button type="button" class="btn btn-danger-modal" id="btnConfirmarCancelarConfirmacion">
                            Sí, cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let idPrestamoACancelar = null;
        let idPrestamoConfACancelar = null;

        function mostrarConfirmacionCancelar(idPrestamo) {
            idPrestamoACancelar = idPrestamo;
            const modal = new bootstrap.Modal(document.getElementById('confirmCancelarSolicitud'));
            modal.show();
        }

        document.getElementById('btnConfirmarCancelar').addEventListener('click', function () {
            if (idPrestamoACancelar) {
                document.getElementById('formCancelar' + idPrestamoACancelar).submit();
            }
        });

        function mostrarConfirmacionCancelarConfirmacion(idPrestamo) {
            idPrestamoConfACancelar = idPrestamo;
            const modal = new bootstrap.Modal(document.getElementById('confirmCancelarConfirmacion'));
            modal.show();
        }

        document.getElementById('btnConfirmarCancelarConfirmacion').addEventListener('click', function () {
            if (idPrestamoConfACancelar) {
                document.getElementById('formCancelarConf' + idPrestamoConfACancelar).submit();
            }
        });
    </script>
</body>

</html>